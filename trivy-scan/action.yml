name: Scan For Vulnerabilities
description: Runs Trivy scanner against a built image
inputs:
  gcp-service-account-key:
    description: Token to access GCP. Use `secrets.GCP_PROD_SERVICE_ACCOUNT_KEY`
    required: true
  image-name:
    description: The base image name to use; defaults to repo name
    required: false
  gcp-project:
    description: The GCP project to target
    required: false
    default: t0-prod
runs:
  using: composite
  steps:
  - name: Compute Docker Values
    shell: bash
    run: |
      DOCKER_IMAGE_NAME=${{ inputs.image-name }}
      [ -z "$DOCKER_IMAGE_NAME"] && DOCKER_IMAGE_NAME=$(echo "${{ github.repository }}" | sed 's#${{ github.repository_owner }}/##')
      DOCKER_FULL_NAME=gcr.io/${{inputs.gcp-project}}/$DOCKER_IMAGE_NAME:latest
      echo "DOCKER_IMAGE_NAME=$DOCKER_IMAGE_NAME" >> $GITHUB_ENV
      echo "DOCKER_FULL_NAME=$DOCKER_FULL_NAME" >> $GITHUB_ENV

  - uses: ymeadows/github-actions-public/lib/setup-gcr@v0
    with:
      service-account-key: ${{ inputs.gcp-service-account-key }}
      project: ${{ inputs.gcp-project }}

  - name: Pull latest image to scan
    shell: bash
    run: docker pull ${{ env.DOCKER_FULL_NAME }}

  - name: Run Trivy vulnerability scanner
    uses: aquasecurity/trivy-action@0.0.22
    with:
      image-ref: ${{env.DOCKER_FULL_NAME}}
      format: 'table'
      exit-code: '1'
      ignore-unfixed: true
      vuln-type: 'os,library'
      severity: 'CRITICAL,HIGH'
